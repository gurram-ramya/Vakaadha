<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VAKAADHA</title>

  <!-- Styles -->
  <link rel="stylesheet" href="index.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Megrim&display=swap" rel="stylesheet"/>
  <script src="./navbar.js"></script>
</head>
<body>
  <!-- HEADER -->
  <header class="navbar">
    <a href="index.html" class="logo">VAKAADHA</a>
    <input type="checkbox" id="menu-toggle"/>
    <label for="menu-toggle" class="menu-icon">&#9776;</label>
    <nav class="nav-links">
      <a href="./index.html" aria-label="Home"><i class="fas fa-house"></i></a>
      <a href="./wishlist.html" aria-label="Wishlist">
        <i class="fas fa-heart"></i><span class="wishlist-count" id="wishlistCount">0</span>
      </a>
      <a href="./cart.html" aria-label="Cart">
        <i class="fas fa-shopping-cart"></i><span id="cartCount">0</span>
      </a>
      <div class="dropdown">
        <a href="./profile.html" aria-label="Profile">
          <i class="fas fa-user"></i> <span id="user-display"></span>
        </a>
        <div class="dropdown-content">
          <a href="profile.html" id="auth-link">Login / Signup</a>
          <div id="logged-in-links" class="hidden">
            <a href="orders.html">My Orders</a>
            <a href="wishlist.html">Wishlist</a>
            <a href="addresses.html">Addresses</a>
            <a href="#" id="logout">Logout</a>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- HERO -->
  <section class="hero-image-section">
    <div class="hero-content">
      <h1 class="hero-title">VAKAADHA</h1>
      <p class="hero-tagline">Made to be experienced, not explained</p>
    </div>
  </section>

  <!-- FEATURED PRODUCTS -->
  <section class="featured-products">
    <h2>Top Picks for You</h2>
    <div class="product-row" id="productGrid"></div>
  </section>

  <!-- Share Modal -->
  <div id="shareModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button class="close" onclick="closeModal('shareModal')">&times;</button>
      <h2>Share this product</h2>
      <div class="share-options">
        <a id="share-whatsapp" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
        <a id="share-facebook" target="_blank"><i class="fab fa-facebook"></i> Facebook</a>
        <a id="share-twitter" target="_blank"><i class="fab fa-x-twitter"></i> Twitter/X</a>
        <button id="copy-link"><i class="fas fa-link"></i> Copy Link</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->

  <script>
    function loadProducts() {
      fetch("/api/products")
        .then(res => res.json())
        .then(products => {
          const grid = document.getElementById("productGrid");
          grid.innerHTML = "";

          products.forEach(prod => {
            const price = "₹" + (prod.price_cents / 100).toFixed(0);

            // Build sizes
            let sizesHtml = "";
            if (prod.variants && prod.variants.length > 0) {
              sizesHtml = `
                <div class="sizes">
                  ${prod.variants.map(v => `<button class="size-btn">${v.size}</button>`).join("")}
                </div>`;
            }

            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
              <div class="product-actions">
                <button class="wishlist-btn"><i class="far fa-heart"></i></button>
                <button class="share-btn"><i class="fas fa-share-alt"></i></button>
              </div>
              <img src="Images/${prod.image_url}" alt="${prod.name}">
              <h3>${prod.name}</h3>
              <p class="price">${price}</p>
              ${sizesHtml}
              <div class="card-actions">
                <button class="btn add-to-cart">Add to Cart</button>
                <button class="btn buy-now">Buy Now</button>
              </div>
            `;

            // attach handler here, with prod in closure
            card.querySelector(".add-to-cart").addEventListener("click", () => {
              let variant;
              const activeSize = card.querySelector(".size-btn.active");
              if (activeSize) {
                variant = prod.variants.find(v => v.size === activeSize.textContent);
              }
              if (!variant && prod.variants.length > 0) {
                variant = prod.variants[0];
              }
              if (!variant) {
                alert("No variant found");
                return;
              }
              addToCart(variant.variant_id, 1);
            });

            grid.appendChild(card);
          });
        })
        .catch(err => console.error("Error loading products:", err));
    }

    document.addEventListener("DOMContentLoaded", loadProducts);
  </script>



  <script>
    // --- keep this as-is ---
    function getOrCreateGuestId() {
      let gid = localStorage.getItem("guest_id");
      if (!gid) {
        gid = crypto.randomUUID();
        localStorage.setItem("guest_id", gid);
      }
      return gid;
    }

    async function addToCart(variantId, quantity = 1) {
      const guestId = getOrCreateGuestId();
      try {
        const res = await fetch(`/api/cart?guest_id=${guestId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ variant_id: variantId, quantity })
        });
        if (!res.ok) throw new Error("Failed to add item");
        const cart = await res.json();
        console.log("Cart updated:", cart);
        alert("Item successfully added to cart!");
      } catch (err) {
        console.error("Add to cart error:", err);
        alert("Could not add to cart");
      }
    }
  </script>

  <script>
    // --- replace your old DOMContentLoaded + loadProducts patch with this ---
    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.getElementById("productGrid");
      const observer = new MutationObserver(() => {
        grid.querySelectorAll(".add-to-cart").forEach((btn) => {
          if (!btn.dataset.bound) {
            btn.dataset.bound = "true";
            btn.addEventListener("click", () => {
              const productCard = btn.closest(".product-card");
              const variantSizeBtn =
                productCard.querySelector(".size-btn.active") ||
                productCard.querySelector(".size-btn");

              if (!variantSizeBtn) {
                alert("Please select a size");
                return;
              }

              const productIndex = Array.from(grid.children).indexOf(productCard);
              const product = window.__loadedProducts[productIndex];
              const variant = product.variants.find(
                (v) => v.size === variantSizeBtn.textContent
              );

              if (!variant) {
                alert("Variant not found");
                return;
              }

              // FIX: correct field name from API
              addToCart(variant.variant_id, 1);
            });
          }
        });
      });
      observer.observe(grid, { childList: true });
    });

    const originalLoadProducts = loadProducts;
    loadProducts = function () {
      fetch("/api/products")
        .then((res) => res.json())
        .then((products) => {
          window.__loadedProducts = products;

          // Re-render grid manually
          const grid = document.getElementById("productGrid");
          grid.innerHTML = "";

          products.forEach((prod) => {
            const price = "₹" + (prod.price_cents / 100).toFixed(0);

            let sizesHtml = "";
            if (prod.variants && prod.variants.length > 0) {
              sizesHtml = `
                <div class="sizes">
                  ${prod.variants
                    .map((v) => `<button class="size-btn">${v.size}</button>`)
                    .join("")}
                </div>`;
            }

            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
              <div class="product-actions">
                <button class="wishlist-btn"><i class="far fa-heart"></i></button>
                <button class="share-btn"><i class="fas fa-share-alt"></i></button>
              </div>
              <img src="Images/${prod.image_url}" alt="${prod.name}">
              <h3>${prod.name}</h3>
              <p class="price">${price}</p>
              ${sizesHtml}
              <div class="card-actions">
                <button class="btn add-to-cart">Add to Cart</button>
                <button class="btn buy-now">Buy Now</button>
              </div>
            `;
            grid.appendChild(card);
          });
        });
    };
  </script>


  <script src="./script.js"></script>
</body>
</html>
