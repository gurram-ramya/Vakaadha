<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email – Vakaadha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0; padding: 0; display: grid; min-height: 100dvh; place-items: center;
      background: #f7f7f8;
    }
    .card {
      width: min(480px, 92vw);
      background: #fff; border-radius: 16px; padding: 24px 20px; box-shadow: 0 6px 30px rgba(0,0,0,.08);
    }
    h1 { margin: 0 0 8px; font-size: 1.4rem; letter-spacing: .2px; }
    p  { margin: 6px 0 14px; color: #555; line-height: 1.45; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .btn {
      appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; cursor: pointer;
      background: #111; color: #fff; font-weight: 600;
    }
    .btn.secondary { background: #ececec; color: #111; }
    .btn.link { background: transparent; color: #111; font-weight: 600; padding: 6px 0; }
    .btn:disabled { opacity: .6; cursor: default; }
    .muted { color: #777; font-size: .9rem; }
    .hint { background: #fafafa; border: 1px solid #eee; border-radius: 10px; padding: 12px; margin-top: 12px; }
    .small { font-size: .85rem; }
    .input {
      width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid #ddd; outline: none;
      font-size: 1rem; box-sizing: border-box;
    }
    .topline { display:flex; align-items:center; justify-content: space-between; gap: 8px; }
    .email-tag { font-weight: 600; }
    .error { color: #b00020; font-size: .9rem; margin-top: 6px; display:none; }
    .ok { color: #0a7b34; font-size: .9rem; margin-top: 6px; display:none; }
    .spinner {
      width: 18px; height: 18px; border: 2px solid #e1e1e1; border-top-color: #111; border-radius: 50%;
      animation: spin 1s linear infinite; display: inline-block; vertical-align: -3px; margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="card" role="main" aria-live="polite">

    <!-- A) LOGIN / CREATION -->
    <section id="screen-password">
      <div class="topline">
        <h1 id="pwHeading">Sign in with password</h1>
        <a class="btn link" href="login.html">Change email</a>
      </div>
      <p class="small">Email: <span class="email-tag" id="pwEmail"></span></p>

      <label class="small" for="pwInput">Password</label>
      <input id="pwInput" class="input" type="password" autocomplete="current-password" placeholder="Your password" />

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="pwSignInBtn">
          <span class="spinner" id="pwSpin" style="display:none"></span>
          Continue
        </button>
      </div>

      <div class="row" style="margin-top:8px;">
        <button class="btn link" id="forgotBtn">Forgot password?</button>
      </div>

      <div id="pwError" class="error"></div>
      <div id="pwOk" class="ok"></div>
    </section>

    <!-- B) CREATION VERIFY (only after creating a brand-new user) -->
    <section id="screen-verify" class="hidden">
      <h1>Verify your email</h1>
      <p id="verifyText">We’ve sent a verification link to your email.</p>

      <div class="hint small">
        Open the email on this device and tap the link to confirm your address. If you don’t see it, check spam.
      </div>

      <div class="row">
        <button class="btn" id="openBtn">
          <span class="spinner" id="spin" style="display:none"></span>
          Open email app
        </button>
        <button class="btn secondary" id="resendBtn">Resend verification</button>
      </div>

      <p class="muted small" style="margin-top:16px;">
        Not your email? <a href="login.html">try another email or phone</a>.
      </p>

      <div id="vOk" class="ok"></div>
      <div id="vErr" class="error"></div>
    </section>

    <!-- C) UPDATE FLOW (verifyBeforeUpdateEmail) -->
    <section id="screen-update" class="hidden">
      <h1>Confirm your new email</h1>
      <p id="updText">We’ve sent a confirmation link to <span class="email-tag" id="updEmail"></span>. Tap the link to update your account email.</p>

      <div class="hint small">
        We’re keeping your account signed in. Once you confirm, we’ll update your email and bring you back to your profile.
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="updOpenBtn">
          <span class="spinner" id="updSpin" style="display:none"></span>
          Open email app
        </button>
        <button class="btn secondary" id="updResendBtn">Resend confirmation</button>
        <a class="btn secondary" id="updCancelBtn" href="profile_edit.html">Cancel</a>
      </div>

      <div id="updOk" class="ok"></div>
      <div id="updErr" class="error"></div>
    </section>

  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- Facade + API -->
  <script src="api/client.js"></script>
  <script src="auth.js"></script>

  <script>
    (function () {
      // =========================
      // Debug (console only)
      // =========================
      const DBG_PREFIX = "[email.html]";
      const ts = () => {
        const d = new Date();
        return d.toTimeString().split(" ")[0] + "." + String(d.getMilliseconds()).padStart(3,"0");
      };
      const dlog = (label, payload) => { try { console.log(`${DBG_PREFIX} ${ts()} ${label}`, payload ?? ""); } catch {} };
      const dwarn = (label, payload) => { try { console.warn(`${DBG_PREFIX} ${ts()} ${label}`, payload ?? ""); } catch {} };
      const derr = (label, payload) => { try { console.error(`${DBG_PREFIX} ${ts()} ${label}`, payload ?? ""); } catch {} };

      // =========================
      // tiny helpers
      // =========================
      const sleep = (ms) => new Promise(r=>setTimeout(r,ms));
      const showSec  = (el)=> el.classList.remove("hidden");
      const hideSec  = (el)=> el.classList.add("hidden");
      const setErr   = (el,msg)=>{ if(!el) return; el.textContent = msg||""; el.style.display = msg?"block":"none"; };
      const setOk    = (el,msg)=>{ if(!el) return; el.textContent = msg||""; el.style.display = msg?"block":"none"; };

      const FLOW_KEY = "__vakaadha_auth_flow__";
      const LS_LAST_EMAIL   = "__vakaadha_last_email__";
      const LS_UPDATE_EMAIL = "__vakaadha_update_email__";

      const readFlow = () => {
        try { return JSON.parse(sessionStorage.getItem(FLOW_KEY)||"{}"); }
        catch { return {}; }
      };
      const writeFlow = (patch) => {
        const cur = readFlow();
        const nxt = { ...cur, ...patch };
        try { sessionStorage.setItem(FLOW_KEY, JSON.stringify(nxt)); } catch {}
        dlog("FLOW_WRITE", nxt);
        return nxt;
      };

      function hereUrl() {
        const u = new URL(window.location.href);
        u.search = ""; u.hash = "";
        return u.toString();
      }

      async function exposeToken(user) {
        try {
          const t = await user.getIdToken(true);
          try { localStorage.setItem("auth_token", t); } catch {}
          try { window.auth?.setToken?.(t); } catch {}
          for (let i=0;i<20;i++){ const tt = await window.auth?.getToken?.(); if (tt) break; await sleep(100); }
        } catch {}
      }

      // =========================
      // elements
      // =========================
      const secPw   = document.getElementById("screen-password");
      const secVer  = document.getElementById("screen-verify");
      const secUpd  = document.getElementById("screen-update");

      const pwHeading = document.getElementById("pwHeading");
      const pwEmailEl = document.getElementById("pwEmail");
      const pwInput   = document.getElementById("pwInput");
      const pwBtn     = document.getElementById("pwSignInBtn");
      const pwSpin    = document.getElementById("pwSpin");
      const pwErr     = document.getElementById("pwError");
      const pwOk      = document.getElementById("pwOk");
      const forgotBtn = document.getElementById("forgotBtn");

      const verifyText = document.getElementById("verifyText");
      const vOk = document.getElementById("vOk");
      const vErr = document.getElementById("vErr");
      const openBtn = document.getElementById("openBtn");
      const resendBtn = document.getElementById("resendBtn");
      const linkSpin = document.getElementById("spin");

      const updEmailEl = document.getElementById("updEmail");
      const updOk  = document.getElementById("updOk");
      const updErr = document.getElementById("updErr");
      const updOpenBtn = document.getElementById("updOpenBtn");
      const updResendBtn = document.getElementById("updResendBtn");
      const updSpin = document.getElementById("updSpin");

      // =========================
      // routing helpers
      // =========================
      async function routeAfterSignIn() {
        const user = firebase.auth().currentUser;
        if (!user) { window.location.href = "login.html"; return; }
        await exposeToken(user);

        try {
          const me = await window.apiRequest("/api/users/me");
          const complete = me && (me.profile_complete === true || me.profile_complete === 1);
          window.location.href = complete ? "index.html" : "complete_profile.html";
        } catch (e) {
          if (Number(e?.status) === 404) window.location.href = "complete_profile.html";
          else if (Number(e?.status) === 401) window.location.href = "login.html";
          else window.location.href = "complete_profile.html";
        }
      }

      async function routeAfterEmailUpdate() {
        const user = firebase.auth().currentUser;
        if (user) await exposeToken(user);
        try { await window.apiRequest("/api/auth/register", { method: "POST", body: {} }); } catch {}
        const f = readFlow();
        const returnTo = f && f.returnTo ? String(f.returnTo) : "profile_edit.html";
        try { localStorage.removeItem(LS_UPDATE_EMAIL); } catch {}
        window.location.href = returnTo;
      }

      // =========================
      // action code consumer (verify links for update flow)
      // =========================
      (function handleActionCodeIfPresent() {
        const params = new URLSearchParams(location.search);
        const mode = params.get("mode");
        const oob  = params.get("oobCode");
        if (mode === "verifyEmail" && oob) {
          (async () => {
            dlog("ACTION_CODE_APPLY_ATTEMPT", { mode, oob: !!oob });
            try {
              await firebase.auth().applyActionCode(oob);
              const u = firebase.auth().currentUser; if (u) await u.reload();
              const f = readFlow();
              dlog("ACTION_CODE_APPLY_OK", f);
              if (f && f.origin === "profile_edit" && f.intent === "update_email") {
                await routeAfterEmailUpdate();
              } else {
                await routeAfterSignIn();
              }
            } catch (e) {
              derr("ACTION_CODE_APPLY_ERR", { code: e?.code, message: e?.message });
              const f = readFlow();
              if (f && f.origin === "profile_edit" && f.intent === "update_email") {
                setErr(updErr, "The confirmation link is invalid or expired. Resend and try again.");
                showSec(secUpd);
              } else {
                showSec(secPw);
              }
            }
          })();
        }
      })();

      // =========================
      // UPDATE FLOW
      // =========================
      async function initUpdateFlow(newEmail) {
        hideSec(secPw); hideSec(secVer); showSec(secUpd);
        updEmailEl.textContent = newEmail;

        try { localStorage.setItem(LS_UPDATE_EMAIL, newEmail); } catch {}

        async function sendUpdateLink() {
          setErr(updErr, ""); setOk(updOk, "");
          updSpin.style.display = "";
          try {
            const u = firebase.auth().currentUser;
            if (!u) { setErr(updErr, "Session expired. Please sign in again."); return; }

            // DO NOT allow if email already exists for any provider
            let methodsForTarget = [];
            try {
              methodsForTarget = await firebase.auth().fetchSignInMethodsForEmail(newEmail);
            } catch (e) {
              dwarn("FETCH_METHODS_FOR_TARGET_UPDATE_ERR", { code: e?.code, message: e?.message });
            }
            dlog("FETCH_METHODS_FOR_TARGET_UPDATE", { email: newEmail, methodsForTarget });

            if ((methodsForTarget || []).length > 0) {
              setErr(updErr, "That email is already in use by another account.");
              return;
            }

            await u.verifyBeforeUpdateEmail(newEmail, {
              url: hereUrl(),
              handleCodeInApp: true
            });
            setOk(updOk, "Confirmation email sent. Check your inbox.");
            writeFlow({ emailUpdate: { sentAt: Date.now(), continueUrl: hereUrl() } });
            dlog("SEND_VERIFY_BEFORE_UPDATE_OK", { email: newEmail });
          } catch (e) {
            const c = String(e?.code || "");
            dlog("SEND_VERIFY_BEFORE_UPDATE_ERR", { code: c, message: e?.message });
            if (c === "auth/requires-recent-login") {
              setErr(updErr, "For security, please sign in again, then retry updating your email.");
            } else if (c === "auth/email-already-in-use") {
              setErr(updErr, "That email is already in use by another account.");
            } else if (c === "auth/operation-not-allowed") {
              setErr(updErr, "Email/password sign-in is disabled for new emails.");
            } else {
              setErr(updErr, "Could not send confirmation email. Try again.");
            }
          } finally {
            updSpin.style.display = "none";
          }
        }

        await sendUpdateLink();

        updOpenBtn.onclick = function () {
          try { if (navigator.userAgent.toLowerCase().includes("android")) { window.location.href = "mailto:"; return; } } catch {}
          const opened = window.open("https://mail.google.com", "_blank", "noopener,noreferrer");
          if (!opened) window.location.href = "mailto:";
        };
        updResendBtn.onclick = sendUpdateLink;
      }

      // =========================
      // LOGIN / CREATION FLOW
      // =========================
      async function initLoginFlow(email) {
        // Always start on password/create screen; verification only after creation succeeds
        showSec(secPw); hideSec(secVer); hideSec(secUpd);
        pwEmailEl.textContent = email;
        verifyText.textContent = "We’ve sent a verification link to " + email;

        // 1) Decide by existing sign-in methods
        let methods = [];
        try {
          methods = await firebase.auth().fetchSignInMethodsForEmail(email);
          dlog("FETCH_METHODS_FOR_LOGIN", { email, methods });
        } catch (e) {
          dwarn("FETCH_METHODS_FOR_LOGIN_ERR", { code: e?.code, message: e?.message });
        }

        // Configure UI strictly based on methods
        if (methods.includes("password")) {
          pwHeading.textContent = "Sign in with password";
          forgotBtn.style.display = "";
          pwBtn.disabled = false;
          setErr(pwErr, ""); setOk(pwOk, "");
        } else if (methods.length === 0) {
          pwHeading.textContent = "Create a password";
          forgotBtn.style.display = "none";
          pwBtn.disabled = false;
          setErr(pwErr, ""); setOk(pwOk, "");
        } else {
          pwHeading.textContent = "Use your original sign-in method";
          forgotBtn.style.display = "none";
          setErr(pwErr, "This email is linked with a different sign-in method (e.g., Google). Use that on the login page.");
          pwBtn.disabled = true; // hard block
        }

        // 2) Submit handler
        pwBtn.onclick = async function () {
          setErr(pwErr,""); setOk(pwOk,"");
          const pwd = String(pwInput.value||"").trim();
          if (!pwd) { setErr(pwErr,"Enter your password."); return; }

          pwBtn.disabled = true; pwSpin.style.display = "";

          try {
            // Re-fetch right before action to avoid stale assumption
            methods = await firebase.auth().fetchSignInMethodsForEmail(email);
            dlog("FETCH_METHODS_BEFORE_SUBMIT", { email, methods });

            // Existing password user → sign in
            if (methods.includes("password")) {
              dlog("SIGN_IN_PASSWORD_ATTEMPT", { email });
              await firebase.auth().signInWithEmailAndPassword(email, pwd);
              try { const u = firebase.auth().currentUser; await u?.reload(); } catch {}
              dlog("SIGN_IN_PASSWORD_OK", { email });
              await routeAfterSignIn();
              return;
            }

            // Brand new email → create user, THEN send verification, THEN poll until verified
            if (methods.length === 0) {
              dlog("CREATE_USER_ATTEMPT", { email });
              try {
                await firebase.auth().createUserWithEmailAndPassword(email, pwd);
                dlog("CREATE_USER_OK", { email });
              } catch (ce) {
                const c = String(ce?.code||"");
                derr("CREATE_USER_ERR", { code: c, message: ce?.message });
                if (c === "auth/weak-password") { setErr(pwErr,"Use a stronger password."); return; }
                if (c === "auth/email-already-in-use") {
                  // Race: another tab created it; try password sign-in
                  try {
                    await firebase.auth().signInWithEmailAndPassword(email, pwd);
                    dlog("CREATE_COLLISION_SIGNIN_OK", { email });
                    await routeAfterSignIn();
                    return;
                  } catch {
                    setErr(pwErr,"This email already has an account. Try your password or Google.");
                    return;
                  }
                }
                if (c === "auth/operation-not-allowed") {
                  setErr(pwErr,"Email & password sign-in is disabled in Firebase.");
                  return;
                }
                setErr(pwErr,"Could not create account.");
                return;
              }

              // We just created the account → send verification (and show verify screen)
              const u = firebase.auth().currentUser;
              hideSec(secPw); showSec(secVer);
              try {
                await u.sendEmailVerification({ url: hereUrl(), handleCodeInApp: true });
                setOk(vOk, "Verification email sent. Waiting for confirmation…");
                dlog("VERIFY_EMAIL_SENT", { to: email });
              } catch (se) {
                derr("VERIFY_EMAIL_SEND_ERR", { code: se?.code, message: se?.message });
                setErr(vErr,"Failed to send verification email.");
              }

              const poll = setInterval(async () => {
                try {
                  const uu = firebase.auth().currentUser; if (!uu) return;
                  await uu.reload();
                  if (uu.emailVerified) {
                    clearInterval(poll);
                    dlog("VERIFY_POLL_OK", { email });
                    await routeAfterSignIn();
                  }
                } catch {}
              }, 3000);
              return;
            }

            // Existing email with non-password provider → blocked (no verification sent)
            setErr(pwErr, "This email is linked with a different sign-in method. Use that method on the login page.");
          } catch (e) {
            const code = String(e?.code||"");
            derr("SUBMIT_ERR", { code, message: e?.message });
            if (code === "auth/wrong-password") setErr(pwErr,"Incorrect password. Try again.");
            else if (code === "auth/too-many-requests") setErr(pwErr,"Too many attempts. Try later.");
            else if (code === "auth/operation-not-allowed") setErr(pwErr,"Email & password sign-in is disabled in Firebase.");
            else setErr(pwErr,"Sign-in failed. Try again.");
          } finally {
            pwBtn.disabled = false; pwSpin.style.display = "none";
          }
        };

        // Submit on Enter (if form exists)
        document.getElementById("pwForm")?.addEventListener("submit", (e) => {
          e.preventDefault();
          pwBtn.click();
        });

        // 3) Forgot password
        forgotBtn.onclick = async function () {
          setErr(pwErr,""); setOk(pwOk,"");
          try {
            await firebase.auth().sendPasswordResetEmail(email);
            setOk(pwOk,"Password reset email sent.");
            dlog("PASSWORD_RESET_SENT", { email });
          } catch (e) {
            derr("PASSWORD_RESET_ERR", { code: e?.code, message: e?.message });
            setErr(pwErr,"Could not send reset email.");
          }
        };

        // 4) Verify screen buttons (only visible when we show verify screen)
        openBtn.onclick = function () {
          try { if (navigator.userAgent.toLowerCase().includes("android")) { window.location.href = "mailto:"; return; } } catch {}
          const opened = window.open("https://mail.google.com", "_blank", "noopener,noreferrer");
          if (!opened) window.location.href = "mailto:";
        };
        resendBtn.onclick = async function () {
          setErr(vErr,""); setOk(vOk,"");
          try {
            const u = firebase.auth().currentUser;
            if (!u) { setErr(vErr,"Session lost. Please sign in again."); return; }
            await u.sendEmailVerification({ url: hereUrl(), handleCodeInApp:true });
            setOk(vOk,"Verification email resent.");
            dlog("VERIFY_EMAIL_RESENT", { to: email });
          } catch (e) {
            derr("VERIFY_EMAIL_RESEND_ERR", { code: e?.code, message: e?.message });
            setErr(vErr,"Failed to resend verification.");
          }
        };

        // 5) If user is somehow already verified (refresh), route on load
        (async () => {
          try {
            const u = firebase.auth().currentUser;
            if (u) {
              await u.reload();
              if (u.emailVerified) await routeAfterSignIn();
            }
          } catch {}
        })();
      }

      // =========================
      // Firebase boot
      // =========================
      async function ensureFirebaseReady() {
        if (firebase?.apps?.length) return;
        const cfg = (window.__FIREBASE_CONFIG__ || window.firebaseConfig || null);
        if (cfg && (!firebase.apps || !firebase.apps.length)) {
          try { firebase.initializeApp(cfg); } catch {}
        }
        for (let i = 0; i < 40 && (!firebase.apps || !firebase.apps.length); i++) {
          await new Promise(r => setTimeout(r, 50));
        }
        if (!firebase?.apps?.length) {
          derr("BOOT_ERR", "Firebase not initialized: no [DEFAULT] app found.");
          throw new Error("firebase-not-initialized");
        }
      }

      // =========================
      // ENTRY
      // =========================
      (async function boot() {
        try {
          await ensureFirebaseReady();
        } catch {
          window.location.href = "login.html";
          return;
        }

        // Read/repair flow
        let f = readFlow();

        // Pull candidates from URL + localStorage for robustness
        let qp;
        try { qp = new URLSearchParams(location.search); } catch { qp = new URLSearchParams(); }
        const fromUpdate     = (qp.get("from") === "update");
        const qpEmail        = (qp.get("e") || qp.get("email") || "").trim();
        const lsUpdateEmail  = (localStorage.getItem(LS_UPDATE_EMAIL) || "").trim();
        const lsLastEmail    = (localStorage.getItem(LS_LAST_EMAIL) || "").trim();

        const flowLooksMissing = !f || Object.keys(f).length === 0 || (!f.email && !f.origin && !f.intent);
        const isUpdateFlow = (f && f.origin === "profile_edit" && f.intent === "update_email") || fromUpdate;

        // Preferred email source order:
        //  - explicit query param
        //  - session flow email
        //  - update fallback (if from update)
        //  - last login email fallback (scenario 1 rescue)
        const emailCandidate = qpEmail || f?.email || (isUpdateFlow ? lsUpdateEmail : lsLastEmail) || "";

        // If arriving from update.html and flow is missing, reconstruct
        if (flowLooksMissing && fromUpdate && (qpEmail || lsUpdateEmail)) {
          f = writeFlow({
            mode: "LINK",
            origin: "profile_edit",
            intent: "update_email",
            type: "EMAIL",
            email: emailCandidate,
            createdAt: Date.now(),
            emailLink: { sentAt: null, continueUrl: hereUrl() },
            returnTo: "profile_edit.html",
          });
        }

        if (f && f.email && !emailCandidate) {
          try { localStorage.setItem(LS_UPDATE_EMAIL, f.email); } catch {}
        }

        dlog("BOOT", { wantsUpdate: isUpdateFlow, emailCandidate, fromUpdate, qp: Object.fromEntries(qp.entries()) });

        if (isUpdateFlow && emailCandidate) {
          // Must be signed in on this UID to update
          let u = firebase.auth().currentUser;
          for (let i = 0; i < 40 && !u; i++) { await sleep(100); u = firebase.auth().currentUser; }
          if (!u) { window.location.href = "login.html"; return; }

          await initUpdateFlow(emailCandidate);
          try { if (firebase?.auth?.().isSignInWithEmailLink(location.href)) updSpin.style.display = ""; } catch {}
          return;
        }

        // Normal creation/login flow
        if (!emailCandidate) { window.location.href = "login.html"; return; }
        pwEmailEl.textContent = emailCandidate;
        await initLoginFlow(emailCandidate);
        try { if (firebase?.auth?.().isSignInWithEmailLink(location.href)) linkSpin.style.display = ""; } catch {}
      })();
    })();
  </script>

  <noscript>
    <p style="padding:12px">JavaScript is required to complete this step.</p>
  </noscript>
</body>
</html>
